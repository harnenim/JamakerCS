<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>애니 라이브러리</title>
<link rel="stylesheet" type="text/css" href="bridge/WebForm.css" />
<script src="view/lib/jquery-3.7.1.min.js"></script>
<script src="bridge/WinAPI.js"></script>
<script src="bridge/Binder.js"></script>
<script src="bridge/WebForm.js"></script>
<script src="bridge/SAMPLE.js"></script>
<script>
Binder.prototype.openFolder = function(path) {
	this._.openFolder(path);
}
Binder.prototype.openExplorer = function(path) {
	this._.openExplorer(path);
}
Binder.prototype.runVideo = function(path) {
	this._.runVideo(path);
}
Binder.prototype.runBDMV = function(path) {
	this._.runBDMV(path);
}
Binder.prototype.selectFolders = function(after) {
	this._.selectFolders(after);
}
Binder.prototype.selectFolder = function(after) {
	this._.selectFolder(after);
}
Binder.prototype.saveSetting = function(setting) {
	this._.saveSetting(setting);
}
Binder.prototype.commit = function(base64) {
	this._.commit(base64);
}
Binder.prototype.openDB = function() {
	this._.openDB();
}
</script>
<script>
const SETTING = {
		order: ["origin", "title", "begin", "end", "tag"]
	,	extsForVideo: ["avi","mkv","mp4","html"]
	,	player: ""
	,	bdPlayer: ""
};
window.main = new WebForm();
{	// main
	main.run = function() {
		this.initializeComponent();
		
		let offset = localStorage.getItem("offset.MediaLibrary");
		if (offset) {
			offset = offset.split(",");
			const top = Number(offset[0]);
			const left = Number(offset[1]);
			const width = Number(offset[2]);
			const height = Number(offset[3]);
			WinAPI.MoveWindow(window, left, top, width, height);
		}
		this.setting = localStorage.getItem("setting.MediaLibrary");
		if (!this.setting) {
			this.setting = JSON.stringify(SETTING);
		}
		
		(() => {
			main.mainView.src = "view/MediaLibrary.html";
			main.mainView.onload = function() {
				// 브라우저 샘플에선 url 변형 필요
				main.frame = main.mainView.contentWindow;
				main.frame._open_ = main.frame.open;
				main.frame.open = function(url, name, options) {
					if (url.substring(0, 4) != "http") {
						url = location.href.substring(0, location.href.lastIndexOf("/")) + "/view/" + url;
					}
					return main.windows[name] = window_open(url, name, options, main.frame);
				}
				
				if(!main.frame.chrome.webview) {
					main.frame.chrome.webview = {};
				}
				main.frame.chrome.webview.hostObjects = { binder: main.binder = new Binder(main) };
				
				const cd = main.mainView.contentDocument;
				cd.addEventListener("dragenter", function(e) {
					e.preventDefault();
					main.showDragging();
				});
			};
		})();
	}
	
	main.initAfterLoad = function() {
		main.super_initAfterLoad();
		
		{
			const req = new XMLHttpRequest();
			req.open('GET', "config/sqlite.db");
			req.responseType = 'arraybuffer';
			req.onload = function(e) {
				const buffer = req.response;
				const base64 = new Uint8Array(buffer).toBase64();
				main.frame.ML.init(main.setting, base64);
			}
			req.onerror = function(e) {
				main.frame.ML.init(main.setting);
			};
			req.send();
		}
		main.frame.$("#btnOpenDB").show();
		
		window.addEventListener("beforeunload", (e) => {
			main.beforeExit(e);
		});
	};
	main.openDB = async function() {
		try {
			const fileBuffer = await window.showOpenFilePicker({ types: [ { description: "sqlite 파일", accept:{ "application/vnd.sqlite3": [".db"] } } ] });
			if (fileBuffer && fileBuffer[0]) {
				main.fileBuffer = fileBuffer[0];
				const file = await fileBuffer[0].getFile();
				
				const fr = new FileReader();
				fr.readAsArrayBuffer(file);
				fr.onload = function(evt) {
					main.frame.ML.loadDB(new Uint8Array(fr.result).toBase64());
				}
			}
		} catch (e) {
			console.log(e);
		}
	}
	
	main.beforeExit = function(e) {
		const offset = new RECT();
		WinAPI.GetWindowRect(window, offset);
		localStorage.setItem("offset.MediaLibrary", [
				offset.top
			,	offset.left
			,	offset.right - offset.left
			,	offset.bottom - offset.top
		].join(","));
	}
}
{
	main.openFolder = function(path) {
		main.frame.ML.openFolder(path, SAMPLE.FileList);
	}
	main.openExplorer = function(path) {
		alert("샘플 페이지");
	}
	main.runVideo = function(path) {
		alert("샘플 페이지");
	}
	main.runBDMV = function(path) {
		alert("샘플 페이지");
	}
	
	main.selectFolders = function(after) {
		// TODO
		const list = [
			"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\AnimeLibrary"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\lyrics"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\movie"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\MovieLog"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\WinPNG"
		];
		main.frame.ML[after](list);
	}
	main.selectFolder = function(after) {
		// TODO
		const list = [
			"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\AnimeLibrary"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\lyrics"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\movie"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\MovieLog"
		,	"C:\\eGovFrameDev-3.8.0-64bit\\workspace\\krhome\\src\\main\\webapp\\_\\WinPNG"
		];
		main.frame.ML[after](list[Math.floor(Math.random() * 5)]);
	}
	main.saveSetting = function(setting) {
		localStorage.setItem("setting.MediaLibrary", setting);
		main.frame.ML.setSetting(setting);
	}
	main.commit = async function(base64) {
		if (main.fileBuffer) {
			const stream = await main.fileBuffer.createWritable();
			await stream.write(Uint8Array.fromBase64(base64).buffer);
			await stream.close();
		} else {
			main.saveWithDialog(base64);
		}
	}
	main.saveWithDialog = async function(base64) {
		const fileBuffer = await window.showSaveFilePicker({ types: [ { description: "sqlite 파일", accept:{ "application/vnd.sqlite3": [".db"] } } ] });
		if (fileBuffer) {
			main.fileBuffer = fileBuffer;
			main.commit(base64);
		}
	}
}
$(() => {
	main.run();
});
</script>
<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}
html, body {
	width: 100%;
	height: 100%;
	border: 0;
	overflow: hidden;
}
</style>
</head>
<body></body>
</html>